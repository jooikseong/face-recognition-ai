# 마라톤 참가자 식별 시스템

이 프로젝트는 마라톤 영상에서 참가자의 배번호(Bib)와 얼굴을 인식하여 식별하는 시스템입니다.

## 🚀 작동 원리

이 시스템은 크게 **"참가자 등록"** 과 **"영상 분석"** 두 단계로 나뉩니다.

1.  **참가자 등록 (`enroll_faces.py`)**:
    * `data/enroll/` 폴더에 참가자 ID(배번호)별로 저장된 얼굴 사진을 불러옵니다.
    * InsightFace 모델을 사용해 각 얼굴의 고유한 '특징값(Embedding)'을 추출합니다.
    * 추출된 특징값들을 `artifacts/` 폴더에 `faiss.index`라는 '얼굴 데이터베이스'로 구축합니다.
    * 이 작업은 시스템 사용 전 **최초 1회**만 실행하면 됩니다.

2.  **영상 분석 (`process_clip.py`)**:
    * `data/clips/` 폴더에 있는 분석할 마라톤 영상을 불러옵니다.
    * 영상 프레임별로 다음 작업을 수행합니다:
        1.  **사람 탐지 (YOLO)**: 영상 속 사람의 위치를 찾습니다.
        2.  **배번호 인식 (OCR)**: 사람의 상체에서 배번호를 찾아 숫자를 읽습니다.
        3.  **얼굴 인식 (InsightFace)**: 영상 속 얼굴의 특징값을 추출하여, `faiss.index` (얼굴 DB)와 비교해 가장 닮은 참가자 ID를 찾습니다.
    * **최종 판정 (`fusion.py`)**:
        * (A) 배번호 인식 결과와 (B) 얼굴 인식 결과를 `config.yaml`에 설정된 가중치(예: 배번호 70%, 얼굴 30%)로 합산합니다.
        * 가장 점수가 높은 참가자를 최종 식별 결과로 확정합니다.
    * `outputs/` 폴더에 식별 결과가 표시된 최종 비디오를 저장합니다.

## 🗂️ 파일 구조 및 역할

* `models.py` **(AI 모델 로더 🧠):**
    * 모든 AI 모델(YOLO, InsightFace, EasyOCR, FAISS)을 불러와서 준비시키는 "엔진 룸"입니다.
    * `process_clip.py`와 `enroll_faces.py`가 AI 기능을 필요로 할 때 이 파일을 사용합니다.

* `enroll_faces.py` **(참가자 등록 📇):**
    * 가장 먼저, 딱 한 번만 실행하는 파일입니다.
    * `data/enroll/` 폴더의 참가자 사진으로 `artifacts/` 폴더에 '얼굴 데이터베이스(faiss.index)'를 생성합니다.

* `process_clip.py` **(메인 영상 분석 🏃‍♂️):**
    * 사용자가 실제로 실행할 메인 파일입니다.
    * 마라톤 영상을 분석하여 배번호와 얼굴을 동시에 인식하고, 최종 식별 결과를 `outputs/` 폴더에 영상으로 저장합니다.

* `ocr_utils.py` **(배번호(Bib) 처리 도우미 🔢):**
    * `process_clip.py`가 배번호를 더 잘 인식할 수 있도록 도와주는 보조 파일입니다.
    * `crop_torso` (사람 상체 자르기), `pick_bib_text` (OCR 결과에서 숫자만 골라내기) 등의 기능을 제공합니다.

* `fusion.py` **(최종 점수 합산기 ⚖️):**
    * `process_clip.py`가 얻어낸 (A) 배번호 점수와 (B) 얼굴 점수를 가중 합산하여, 최종적으로 가장 유력한 참가자 1명을 결정합니다.
